kind: module
name: fullpass_resolve_event 
spec:
  decoders:
    caller:
      resolve:
        ref:
          any: text
        identity:
          any: text
        ts:
          any: date
    facebook:
      noEvent: no_such_event
      event:
        any: object
    service:
      location:
        address:
          any: text
        location:
          lat:
            any: number
          lon:
            any: number
      noLocation: noLocation
    stream:
      streamed: true
    store:
      existingEvent:
        projection:
          any: object
      newEvent:
        projection: not_found 
  update:
    resolve:
      model:
        event: "@data"
      cmds:
        store: findProjection
    existingEvent: {}
    newEvent:
      cmds:
        facebook: resolveEvent
    noEvent:
      cmds:
        stream: noEvent
    noLocation:
      cmds:
        stream: noLocation
    event:
      model:
        event: 
          merge:
            - "@data"
            - "@model.event"
      cmds:
        service: location
    location:
      model:
        event:
          merge:
            - "@data"
            - "@model.event"
      cmds:
        stream: resolved
    streamed: {}
  encoders:
    findProjection:
      store: "@store"
      fetch:
        id: "@event.ref"
      from: events_view
      as: projection
    resolveEvent:
      object:
        resolve: "@event.ref"
    location:
      app: geoLocation
      params:
        query: 
          join:
            - maybe: "@event.place"
            - maybe: "@event.street"
            - maybe: "@event.zip"
            - maybe: "@event.area"
            - maybe: "@event.country"
          using: " "
    noEvent:
      write: "@event"
      to: events_unknown
    noLocation:
      write: "@event"
      to: events_unlocated
    resolved:
      write: "@event"
      to: events_resolved