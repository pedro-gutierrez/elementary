kind: module
name: fullpass_resolve_event 
spec:
  decoders:
    caller:
      resolve:
        ref:
          any: text
        identity:
          any: text
        ts:
          any: date
    service:
      noEvent: noEvent
      event:
        event:
          any: object
      location:
        address:
          any: text
        location:
          lat:
            any: number
          lon:
            any: number
      noLocation: noLocation
    store:
      updated:
        any: number
  update:
    resolve:
      model:
        event: "@data"
      cmds:
        service: facebook_get_event
    noEvent:
      cmds:
        stream: noSuchEvent
    noLocation:
      cmds:
        stream: noLocation
    event:
      model:
        event: 
          merge:
            - "@data.event"
            - "@model.event"
      cmds:
        service: location
    location:
      model:
        event:
          merge:
            - "@model.event"
            - "@data"
      cmds:
        store: resolved
    updated:
      cmds:
        slack: resolved_alert
  encoders:
    facebook_get_event:
      app: facebook_get_event 
      params:
        id: "@event.ref"
    location:
      app: geoLocation
      params:
        query: 
          join:
            - maybe: "@event.place"
            - maybe: "@event.street"
            - maybe: "@event.zip"
            - maybe: "@event.area"
            - maybe: "@event.country"
          using: " "
    noSuchEvent:
      write: "@event"
      to: events_unknown
    noLocation:
      write: "@event"
      to: events_unlocated
    resolved:
      store: "@store"
      ensure: "@event"
      where:
        id: "@event.id"
      into: "events_view"
    resolved_alert:
      object:
        channel: events
        text:
          format: "Event *{{ title }}* with id *{{ id }}* was resolved"
          params: "@event"
