kind: module
name: google_token
spec:
  decoders:
    http:
      get_token:
        query:
          code:
            any: text
          state:
            any: text
      invalid:
        status: 400
      token:
        body:
          access_token:
            any: text
          expires_in:
            any: number
          id_token:
            any: text
      user_info:
        body:
          email:
            any: text
          name:
            any: text
          picture:
            any: text
          sub:
            any: text
    jwt:
      claims:
        claims:
          email:
            any: text
          sub:
            any: text
    service:
      nonce_verified:
        consumed: true 
      nonce_not_verified:
        consumed: false
      identity_updated:
        identity:
          id: 
            any: text
      session_created:
        session:
          any: text
  update:
    get_token:
      model: "@data.query"
      cmds:
        service: consume_nonce
    nonce_verified:
      cmds:
        http: get_token
    nonce_not_verified:
      cmds:
        return: error
    invalid:
      cmds:
        return: error
    token:
      model: "@data.body"
      cmds:
        jwt: decode_token
    claims:
      model:
        session:
          uuid: {}
      cmds:
        http: get_user_info
    user_info:
      model:
        user: "@data.body"
      cmds:
        service: "identity"
    identity_updated:
      model:
        identity: "@data.identity.id"
      cmds:
        service: create_session
    session_created:
      model:
        session: "@data.session"
      cmds:
        return: session
  encoders:
    consume_nonce:
      app: token
      params:
        consume: "@state"
    get_token:
      method: post
      url: https://accounts.google.com/o/oauth2/token
      headers:
        content-type: application/x-www-form-urlencoded
      body:
        client_id: "@client" 
        client_secret: "@secret"
        grant_type: authorization_code
        redirect_uri:
          format: "{{ baseUrl }}{{ redirectPath }}"
        code: "@code"
    decode_token:
      decode: "@id_token"
    get_user_info:
      method: get
      url: https://www.googleapis.com/oauth2/v3/userinfo
      headers:
        authorization:
          format: "Bearer {{ access_token }}"
    identity:
      app: "identity"
      params:
        update:
          kind: "google"
          id: "@user.sub"
          email: "@user.email"
          picture: "@user.picture"
          name: "@user.name"
      as: identity
    create_session:
      app: token
      params:
        session:
          identity: "@identity"
    error:
      status: 302
      headers:
        location:
          format: "{{ baseUrl }}/#/error"
    session:
      status: 302
      headers:
        location:
          format: "{{ baseUrl }}/#/?session={{ session }}"
