kind: module
name: google_session
spec:
  decoders:
    http:
      create_session:
        params:
          stage: session
    app:
      nonce:
        nonce:
          any: text
  update:
    create_session:
      cmds:
        app: nonce
    nonce:
      model:
        nonce: "@data.nonce"
      cmds:
        return: authorize
  encoders:
    nonce:
      app: token 
      params:
        create: "nonce"
    authorize:
      status: 302
      headers:
        location:
          encoder: google_auth_url
    google_auth_url:
      uri: "https://accounts.google.com/o/oauth2/v2/auth"
      with:
        client_id: "@client"
        state: "@nonce"
        scope: "profile email"
        response_type: "code"
        redirect_uri:
          format: "{{ baseUrl }}{{ redirectPath }}"
