kind: module
name: health
spec:
  decoders:
    http:
      get:
        any: object
    store:
      cluster:
        cluster:
          any: list
      streams:
        streams:
          any: list
  update:
    get:
      cmds:
        store: cluster
    cluster:
      model:
        cluster: "@data.cluster"
      cmds:
        store: streams
    streams:
      model:
        let:
          cluster: "@model.cluster"
          store: "@model.store"
          streams: "@data.streams"
        in:
          data:
            encoder: health
      cmds:
        return: data
  encoders:
    cluster:
      store: "@store"
      from: cluster
      aggregate:
        - $addFields:
            object:
              now: $$NOW
      as: cluster
    streams:
      store: "@store"
      from: streams
      aggregate:
        - $addFields:
            object:
              now: $$NOW
      as: streams
    streamInfo:
      name: "@id"
      idle:
        durationBetween: 
          - "@ts"
          - "@now"
      host: "@host"
    hostInfo:
      host: "@host"
      size: "@size"
      partition: "@p"
      lastSeen:
        durationBetween:
          - "@ts"
          - "@now"
    health:
      object:
        cluster:
          map: "@cluster"
          with: 
            encoder: hostInfo
        streams:
          map: "@streams"
          with:
            encoder: streamInfo
        memory:
          memory: {}