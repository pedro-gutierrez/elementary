kind: module
name: ui_billing
spec:
  init:
    model:
      products: []
      subscription: {}
  decoders:
    router:
      show-subscriptions:
        route: /subscriptions
        query:
          session:
            any: text
      show-subscription-approved:
        route: /subscription/approved
        query:
          session:
            any: text
    http:
      products:
        products:
          body:
            any: list
      subscription:
        subscription:
          status: 201
          body:
            id:
              any: text
            product:
              id:
                any: text
              name:
                any: text
            plan:
              id:
                any: text
              name:
                any: text
              price:
                any: number
    ui:
      choose-plan:
        choose:
          plan:
            any: text
          product:
            any: text
          id:
            any: text
  update:
    show-subscriptions:
      model:
        session: "@data.query.session"
        view: loading-view
        onProfile:
          http: get-products
      cmds:
        http: get-profile
        ui: layout-view
    show-subscription-approved:
      model:
        session: "@data.query.session"
        view: subscription-approved-view
      cmds:
        ui: layout-view
    products:
      model:
        view: subscriptions-view
        products: "@data.products.body"
      cmds:
        ui: member-layout-view
    choose-plan:
      model:
        subscription: "@data.choose"
        view: loading-view 
      cmds:
        http: create-subscription
        ui: layout-view
    subscription:
      model:
        subscription: "@data.subscription.body"
        view: plan-selection-confirm-view 
      cmds:
        ui: member-layout-view
  encoders:
    subscriptions-view:
      tag: div
      attrs:
        class: content
      children:
        - tag: h1
          children:
            - Select a plan
        - view: products-view
        - tag: h1
          children:
            - Past subscriptions 
        - view: notification-view
          params:
            message: You have no past subscriptions
    products-view:
      tag: div
      children:
        loop: "@products"
        with: product-view
        params:
          subscription: "@subscription"
          session: "@session"
          action-view: choose-plan-button-view
    product-view:
      tag: div
      attrs:
        class: pricing-table
      children:
        loop: "@plans"
        with: plan-view
        params:
          subscription: "@subscription"
          session: "@session"
          product: "@id"
          action-view: "@action-view"
    plan-view:
      tag: div
      attrs:
        class: pricing-plan
      children:
        - tag: div
          attrs:
            class: plan-header
          children:
            - "@name"
        - tag: div
          attrs:
            class: plan-price
          children:
            - tag: span
              attrs:
                class: plan-price-amount
              children:
                - tag: span
                  attrs:
                    class: plan-price-currency
                  children:
                    - "â‚¬"
                - "@price"
            - "/month"
        - tag: div
          attrs:
            class: plan-items
          children:
            - tag: div
              attrs:
                class: plan-item
              children:
                - "5 passes/year"
            - tag: div
              attrs:
                class: plan-item
              children:
                - "-"
        - tag: div
          attrs:
            class: plan-footer
          children:
            - view: "@action-view"
    plan-selection-confirm-view:
      tag: div
      attrs:
        class: content
      children:
        - tag: h1
          children:
            - Confirm your selection
        - view: product-view
          params:
            subscription: "@subscription"
            session: "@session"
            id: "@subscription.product.id"
            plans:
              - "@subscription.plan"
            action-view: confirm-plan-button-view
    choose-plan-button-view:
      tag: a
      attrs:
        class: button is-fullwidth
        onclick:
          choose:
            plan: "@id"
            product: "@product"
            id:
              uuid: {}
      children:
        - "Choose"
    confirm-plan-button-view:
      tag: a
      attrs:
        class: button is-primary is-fullwidth
        href: 
          format: "/api/billing/subscriptions/{{ id }}/confirm?token={{ token }}"
          params:
            id: "@subscription.id"
            token: "@session"
      children:
        - view: icon-view
          params:
            title: "Pay with Paypal"
            icon: fab fa-paypal
        - tag: span
          children:
            - "Proceed with payment"
    subscription-approved-view:
      tag: div
      children:
        - view: dialog-view
          params:
            title: Success
            message: Your subscription has been succesfully processed.
            session: "@session"
            actions:
              - route: subscriptions 
    get-products:
      method: get
      path: /api/billing/products
      headers:
        authorization: "@session"
      as: products
    create-subscription:
      method: post 
      path: /api/billing/subscriptions
      headers:
        content-type: application/json
        authorization: "@session"
      body: "@subscription"
      as: subscription 
