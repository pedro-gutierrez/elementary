kind: module
name: ui_billing
spec:
  init:
    model:
      products: []
  decoders:
    router:
      show-subscriptions:
        path: /subscriptions
        query:
          session:
            any: text
    http:
      products:
        products:
          body:
            any: list
    ui:
      subscribe:
        billing: subscribe
        plan:
          any: text
        product:
          any: text
  update:
    show-subscriptions:
      model:
        session: "@data.query.session"
        view: loading-view
        onProfile:
          http: get-products
      cmds:
        http: get-profile
        ui: layout-view
    products:
      model:
        view: subscriptions-view
        products: "@data.products.body"
      cmds:
        ui: member-layout-view
    subscribe:
      model:
        subscription: "@data"
        view: loading-view
      cmds:
        http: create-subscription
        ui: layout-view
  encoders:
    subscriptions-view:
      tag: div
      attrs:
        class: content
      children:
        - tag: h1
          children:
            - Select a plan
        - view: products-view
        - tag: h1
          children:
            - Past subscriptions 
        - view: notification-view
          params:
            message: You have no past subscriptions
    products-view:
      tag: div
      children:
        loop: "@products"
        with: product-view
        params:
          session: "@session"
    product-view:
      tag: div
      attrs:
        class: pricing-table
      children:
        loop: "@plans"
        with: plan-view
        params:
          session: "@session"
          product: "@id"
    plan-view:
      tag: div
      attrs:
        class: pricing-plan
      children:
        - tag: div
          attrs:
            class: plan-header
          children:
            - "@name"
        - tag: div
          attrs:
            class: plan-price
          children:
            - tag: span
              attrs:
                class: plan-price-amount
              children:
                - tag: span
                  attrs:
                    class: plan-price-currency
                  children:
                    - "â‚¬"
                - "@price"
            - "/month"
        - tag: div
          attrs:
            class: plan-items
          children:
            - tag: div
              attrs:
                class: plan-item
              children:
                - "5 passes/year"
            - tag: div
              attrs:
                class: plan-item
              children:
                - "-"
        - tag: div
          attrs:
            class: plan-footer
          children:
            - tag: a
              attrs:
                class: button is-fullwidth
                href: 
                  format: "/api/billing/subscribe?plan={{ plan }}&product={{ product }}&token={{ token }}"
                  params:
                    plan: "@id"
                    product: "@product"
                    token: "@session"
              children:
                - "Choose"
    get-products:
      method: get
      path: /api/billing/products
      headers:
        authorization: "@session"
      as: products
