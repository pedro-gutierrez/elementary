kind: module
name: fullpass_create_event 
spec:
  decoders:
    http:
      create:
        method: POST
        body:
          id:
            any: text
          source:
            one_of:
              - facebook
      raw:
        facebook:
          status: 200
          body:
            any: text
      not_found:
        facebook:
          status: 404
    store:
      updated:
        updated: 1
  update:
    create:
      model:
        event: "@data.body"
      cmds:
        http: event_page 
    raw:
      model:
        data:
          maybe:
            let:
              meta: 
                json:
                  resolve:
                    - first:
                        html: script[type="application/ld+json"]
                        in: "@data.facebook.body"
                    - "children"
            in:
              name: "@meta.name"
              url: "@meta.url"
              starts: 
                date: "@meta.startDate"
              cover: "@meta.image"
              location: "@meta.location.name"
              status: success
          otherwise:
            status: no_metadata
          debug: true
      cmds:
        store: update 
    not_found:
      cmds:
        return: not_found
    updated:
      cmds:
        return: accepted
  encoders:
    event_page:
      method: get
      url:
        format: "https://m.facebook.com/events/{{ id }}"
        params:
          id: "@event.id"
      as: facebook
    update:
      store: "@store"
      ensure:
        merge:
          - updated_by: "@session.identity"
            source: "@event.source"
            updated:
              now: {}
          - "@data"
      where:
        id: "@event.id"
      into: fullpass
      as: updated