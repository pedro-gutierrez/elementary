kind: module
name: fullpass_create_event 
spec:
  decoders:
    http:
      create:
        method: POST
        body:
          id:
            any: text
          source:
            oneOf:
              - facebook
      raw:
        facebook:
          status: 200
          body:
            any: text
      locations:
        locations:
          status: 200
          body:
            results:
              list:
                formatted_address:
                  any: text
                geometry:
                  location:
                    lat:
                      any: number
                    lng: 
                      any: number
      not_found:
        facebook:
          status: 404
    store:
      updated:
        updated: 1
  update:
    create:
      model:
        event: "@data.body"
      cmds:
        http: event_page 
    raw:
      model:
        data:
          maybe:
            let:
              meta: 
                json:
                  resolve:
                    - first:
                        html: script[type="application/ld+json"]
                        in: "@data.facebook.body"
                    - "children"
            in:
              name: "@meta.name"
              url: "@meta.url"
              starts: 
                date: "@meta.startDate"
              cover: "@meta.image"
              location: "@meta.location.name"
              status: success
          otherwise:
            status: no_metadata
      cmds:
        http: location
    locations:
      model:
        let:
          location:
            first: "@data.locations.body.results"
        in:
          data:
            merge:
              - "@model.data"
              - address: "@location.formatted_address"
                place:
                  lat: "@location.geometry.location.lat"
                  lon: "@location.geometry.location.lng"
      cmds:
        store: update
    not_found:
      cmds:
        return: not_found
    updated:
      cmds:
        return: accepted
  encoders:
    event_page:
      method: get
      url:
        format: "https://m.facebook.com/events/{{ id }}"
        params:
          id: "@event.id"
      as: facebook
    location:
      method: get
      url: https://maps.googleapis.com/maps/api/geocode/json
      query:
        key: "@google.apiKey"
        address: "@data.location"
      as: locations
    update:
      store: "@store"
      ensure:
        merge:
          - updated_by: "@session.identity"
            source: "@event.source"
            updated:
              now: {}
          - "@data"
      where:
        id: "@event.id"
      into: fullpass
      as: updated