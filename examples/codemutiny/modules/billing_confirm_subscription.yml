kind: module
name: billing_confirm_subscription
spec:
  decoders:
    http:
      confirm_subscription:
        params:
          id:
            any: text
      access_token:
        body:
          access_token:
            any: text
      approval_pending_received:
        body:
          create_time:
            any: date
          id:
            any: text
          links:
            first:
              with:
                href:
                  any: text
                rel:  approve
          status: APPROVAL_PENDING
          start_time:
            any: date
    store:
      not_found:
        subscription: not_found
      subscription:
        subscription:
          id:
            any: text
          plan:
            any: text
          product:
            any: text
      confirmed:
        confirmed: 1
      approval_pending_updated:
        approval_pending_updated: 1
      subscription_error:
        approval_pending_updated: 0
    service:
      nonce:
        nonce:
          any: text
  update:
    confirm_subscription:
      model:
        id: "@data.params.id"
      cmds:
        store: find_subscription
    not_found:
      cmds:
        return: not_found
    subscription:
      model:
        subscription: "@data.subscription"
      cmds:
        store: update_confirmed
    confirmed:
      cmds:
        http: get_access_token
    access_token:
      model:
        token: "@data.body.access_token"
      cmds:
        service: create_nonce
    nonce:
      model:
        nonce: "@data.nonce"
      cmds:
        http: create_paypal_subscription
    approval_pending_received:
      model:
        approval_pending: "@data.body"
      cmds:
        store: update_approval_pending
    approval_pending_updated:
      cmds:
        return: paypal_redirect
  encoders:
    find_subscription:
      store: "@store"
      fetch:
        id: "@id"
        confirmed: null 
        identity: "@session.identity"
      from: subscriptions
      as: subscription 
    update_confirmed:
      store: "@store"
      update:
        confirmed:
          now: {}
      where:
        id: "@id"
        identity: "@session.identity"
      into: subscriptions
      as: confirmed
    create_nonce:
      app: token
      params:
        create: "nonce"
        meta:
          subscription: "@id"
          session: "@session.id"
          identity: "@session.identity"
    update_approval_pending:
      store: "@store"
      update:
        approval_pending:
          now: {}
        gateway:
          name: paypal
          id: "@approval_pending.id"
      where:
        approval_pending: null
        id: "@id"
      into: subscriptions
      as: approval_pending_updated
    get_access_token:
      method: POST
      url: 
        uri: https://api.sandbox.paypal.com/v1/oauth2/token
        with:
          grant_type: client_credentials 
      headers:
        accept: application/json
        accept-language: en_US
        content-type: application/x-www-form-urlencoded
        authorization:
          basic_auth:
            user: "@paypal.client"
            password: "@paypal.secret"
    create_paypal_subscription:
      method: POST
      url: https://api.sandbox.paypal.com/v1/billing/subscriptions
      headers:
        accept: application/json
        content-type: application/json
        authorization:
          format: "Bearer {{ token }}"
        PayPal-Request-Id: "@nonce"
        prefer: return=representation
      body:
        plan_id: "@subscription.plan"
        start_time: "2020-06-12T06:00:00Z"
        subscriber:
          name:
            given_name: John
            surname: Doe
          email_address: customer@example.com
        application_context:
          brand_name: example
          locale: en-US
          shipping_preference: SET_PROVIDED_ADDRESS
          user_action: SUBSCRIBE_NOW
          payment_method: 
            payer_selected: PAYPAL
            payee_preferred: IMMEDIATE_PAYMENT_REQUIRED
          return_url: 
            format: "{{ baseUrl }}/api/billing/subscription/approved?nonce={{ nonce }}"
            params:
              baseUrl: "@paypal.baseUrl"
          cancel_url: 
            format: "{{ baseUrl }}/api/billing/subscription/cancelled?nonce={{ nonce }}"
            params:
              baseUrl: "@paypal.baseUrl"
    paypal_redirect:
      status: 302
      headers:
        location: "@approval_pending.links.href"
