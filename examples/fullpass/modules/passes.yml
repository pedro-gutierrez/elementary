kind: module
name: passes
spec:
  decoders:
    http:
      list:
        method: GET
        query:
          event:
            any: text
      create:
        method: POST
        body:
          id:
            any: text
          event:
            any: text
          kind:
            one_of:
              - full
              - party
              - day
          genre:
            one_of:
              - men
              - women
              - couple
    store:
      created:
        status: created
      conflict:
        status: conflict
      not_found:
        status: not_found
      event:
        event:
          id:
            any: text
      passes:
        passes:
          any: list
  update:
    create:
      model:
        pass:
          merge:
            - @data.body
            - owner: @model.user.id
      cmds:
        store: find_event
    list:
      model:
        event: @data.query.event
      cmds:
        store: find_passes
    event:
      cmds:
        store: create
    passes:
      model:
        passes: @data.passes
      cmds:
        return: passes
    conflict:
      cmds:
        return: conflict
    created:
      cmds:
        return: created
    not_found:
      cmds:
        return: not_found
    invalid:
      cmds:
        return: invalid
  encoders:
    find_event:
      store: @store
      fetch:
        id: @pass.event
      from: events
      as: event
    find_passes:
      store: @store
      find:
        event: @event
      from: passes
      as: passes
    create:
      store: @store
      insert: @pass
      into: passes
    passes:
      status: 200
      headers:
        content-type: application/json
      body: @passes

