kind: module
name: offers
spec:
  decoders:
    http:
      find:
        method: GET
      create:
        method: POST
        body:
          id:
            any: text
          asset:
            any: text
          price:
            any: number
          currency:
            one_of:
              - EUR
          expires:
            any: date
    store:
      updated:
        status: updated
      conflict:
        status: conflict
      not_found:
        status: not_found
      event:
        event:
          id:
            any: text
      asset:
        asset:
          any: object
      offers:
        offers:
          any: list
  update:
    find:
      cmds:
        store: find_offers
    create:
      model:
        offer: @data.body
      cmds:
        store: find_asset
    asset:
      model:
        asset: @data.asset
      cmds:
        store: update
    offers:
      model:
        offers: @data.offers
      cmds:
        return: offers
    updated:
      cmds:
        return: ok
    conflict:
      cmds:
        return: unauthorized
    not_found:
      cmds:
        return: not_found
  encoders:
    find_offers:
      store: @store
      find:
        owner: @user.id
      from: offers
      as: offers
    find_asset:
      store: @store
      fetch:
        id: @offer.asset
      from: assets
      as: asset
    update:
      store: @store
      update:
        price: @offer.price
        currency: @offer.currency
        expires: @offer.expires
        status: active
        modified:
          now: {}
      where:
        id: @offer.id
        owner: @user.id
        kind: @asset.kind
        genre: @asset.genre
        asset: @asset.id
        event: @asset.event
      into: offers
    offers:
      status: 200
      headers:
        content-type: application/json
      body: @offers
