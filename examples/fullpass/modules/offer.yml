kind: module
name: offer
spec:
  decoders:
    http:
      find_to_withdraw:
        method: DELETE
        params:
          id:
            any: text
      find_to_expire:
        method: PUT
        params:
          id:
            any: text
        body:
          expires:
            any: date
    store:
      updated:
        status: updated
      conflict:
        status: conflict
      not_found:
        status: not_found
      offer:
        offer:
          any: object
  update:
    find_to_withdraw:
      model:
        context: withdraw
        offer: @data.params.id
      cmds:
        store: find
    find_to_expire:
      model:
        context: expire
        offer: @data.params.id
        expires: @data.body.expires
      cmds:
        store: find
    offer:
      model:
        offer: @data.offer
      cmds:
        store: @model.context
    updated:
      cmds:
        return: ok
    conflict:
      cmds:
        return: unauthorized
    not_found:
      cmds:
        return: not_found
  encoders:
    find:
      store: @store
      fetch:
        id: @offer
      from: offers
      as: offer
    withdraw:
      store: @store
      update:
        status: withdrawn
        expires:
          now: {}
        modified:
          now: {}
      where:
        id: @offer.id
        owner: @user.id
      into: offers
    expire:
      store: @store
      update:
        expires: @expires
        modified:
          now: {}
      where:
        id: @offer.id
        owner: @user.id
      into: offers
