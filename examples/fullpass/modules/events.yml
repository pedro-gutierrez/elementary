kind: module
name: events
spec:
  decoders:
    http:
      nearby:
        method: GET
        query:
          lat:
            any: float
          lon:
            any: float
      monthly:
        method: GET
        query:
          month:
            any: int
          year:
            any: int
      create:
        method: POST
        headers:
          content-type: application/json
        body:
          id:
            any: text
          name:
            any: text
          place:
            any: text
          starts:
            any: date
          ends:
            any: date
    store:
      created:
        status: created
      conflict:
        status: conflict
      not_found:
        status: not_found
      place:
        place:
          any: object
      places:
        places:
          any: list
      events:
        events:
          any: list
  update:
    nearby:
      model:
        coordinates:
          - @query.lon
          - @query.lat
      cmds:
        store: nearby_places
    monthly:
      model:
        minStart:
          date:
            day: 1
            month: @query.month
            year: @query.year
        maxEnd:
          date:
            day: 31
            month: @query.month
            year: @query.year
      cmds:
        store: monthly_events
    create:
      model:
        event: @body
      cmds:
        store: find_place
    place:
      cmds:
        store: create
    places:
      model:
        places:
          map: @places
          with: @id
      cmds:
        store: events_query
    conflict:
      cmds:
        return: conflict
    created:
      cmds:
        return: created
    events:
      model:
        events: @events
      cmds:
        return: events
    not_found:
      cmds:
        return: not_found
  encoders:
    nearby_places:
      store: @store
      find:
        location:
          $near:
            $geometry:
              type: Point
              coordinates: @coordinates
            $minDistance: 0
            $maxDistance: 100000
      from: places
      as: places
    monthly_events:
      store: @store
      find:
        $or:
          - starts:
              $gte: @minStart
              $lte: @maxEnd
          - ends:
              $gte: @minStart
              $lte: @maxEnd
      from: events
      as: events
    events_query:
      store: @store
      find:
        place:
          $in: @places
      from: events
      as: events
    find_place:
      store: @store
      fetch:
        id: @event.place
      from: places
      as: place
    create:
      store: @store
      insert: @event
      into: events
    list:
      store: @store
      from: events
    events:
      status: 200
      headers:
        content-type: application/json
      body: @events
