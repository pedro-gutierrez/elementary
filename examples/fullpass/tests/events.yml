kind: test
name: events
spec:
  init:
    in_one_month:
      date:
        in:
          month: 1
    in_two_months:
      date:
        in:
          month: 2
  steps:
    - title: Given the Afrofestival
      steps:
        - Given next month
        - Given details for the Afrofestival
        - When I create that event
        - Then I should have a 201
    - title: Given the Feeling Festival
      steps:
        - Given in two months
        - Given details for the Afrofestival
        - Given details for the Feeling Festival
        - When I create that event
        - Then I should have a 201
    - title: Given details for the Afrofestival
      event:
        id: f538d736
        name: Afrofestival
        place: @place.id
        starts:
          format_date: @in_one_month
        ends:
          format_date: @in_one_month
    - title: Given details for the Feeling Festival
      event:
        id: e7295fcb
        name: Feeling Festival
        place: @place.id
        starts:
          format_date: @in_two_months
        ends:
          format_date: @in_two_months
    - title: Given new, invalid dates for that event
      let:
        invalid_date:
          format_date:
            date:
              day: 30
              month: 2
              year: 2020
      in:
        event:
          merge:
            - starts: @invalid_date
              ends: @invalid_date
            - @event
      debug: true
    - title: Given next month
      object:
        date: @in_one_month
    - title: Given in two months
      object:
        date: @in_two_months
    - title: When I create that event
      http:
        method: post
        url:
          - @baseUrl
          - /api/events
        headers:
          content-type: application/json
          client-id: mobile
          client-secret: @clients.mobile
          authorization: @token
        body: @event
      as: latest
    - title: When I look for events nearby
      http:
        method: get
        url:
          - @baseUrl
          - /api/events
        headers:
          content-type: application/json
          client-id: mobile
          client-secret: @clients.mobile
          authorization: @token
        query: @location
      as: latest
    - title: When I look for events for that month
      http:
        method: get
        url:
          - @baseUrl
          - /api/events
        headers:
          content-type: application/json
          client-id: mobile
          client-secret: @clients.mobile
          authorization: @token
        query:
          month:
            month_from: @date
          year:
            year_from: @date
      as: latest
    - title: Then that event should match that item
      assert:
        equal:
          - @item.name
          - @event.name
    - title: When I get that event
      http:
        method: get
        url:
          - @baseUrl
          - /api/events/
          - @event.id
        headers:
          authorization: @token
          client-id: mobile
          client-secret: @clients.mobile
      as: latest
    - title: Then I should have that event
      expect:
        body:
          id: @event.id
      in: @latest
    - title: Given a fake event
      event:
        id: "unknown"
    - title: Given a cover
      cover:
        file: cover.jpg
    - title: When I set that event cover
      http:
        method: post
        url:
          - @baseUrl
          - /api/events/
          - @event.id
          - /cover
        headers:
          client-id: mobile
          client-secret: @clients.mobile
          authorization: @token
        body: @cover.data
      as: latest
    - title: When I get that event cover
      http:
        method: get
        url:
          - @baseUrl
          - /api/events/
          - @event.id
          - /cover
        headers:
          client-id: mobile
          client-secret: @clients.mobile
          authorization: @token
      as: latest
    - title: When I reschedule that event
      http:
        method: put
        url:
          - @baseUrl
          - /api/events/
          - @event.id
        headers:
          client-id: mobile
          client-secret: @clients.mobile
          authorization: @token
          content-type: application/json
        body:
          starts: @date
          ends: @date
      as: latest
