kind: module
name: login
spec:
  decoders:
    entity:
      not_found:
        status: not_found
      user:
        status: ok
        user:
          any: dict
      password:
        status: ok
        password:
          any: dict
      success:
        status: ok
        create:
          token:
            any: dict
    password:
      verified:
        status: ok
    uuid:
      token:
        uuid:
          any: text
  update:
    created:
      model: @
      cmds:
        entity: user
    not_found:
      cmds:
        return: forbidden
    user:
      model:
        user: @user
      cmds:
        entity: password
    password:
      model:
        stored_password: @password
      cmds:
        password: verify
    verified:
      cmds:
        uuid: {}
    token:
      model:
        token: @uuid
      cmds:
        entity: token
    success:
      cmds:
        return: profile
  encoders:
    user:
      first: user
      in: @store
      where:
        username: @username
    password:
      first: password
      in: @store
      where:
        user: @user.id
    verify:
      verify: @password
      with: @stored_password.hash
    token:
      create:
        token:
          id: @token
          version: 1
          value: @token
          acl: read
          user: @user.id
      in: @store
    profile:
      user: @user
      token: @token
