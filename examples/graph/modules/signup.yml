kind: module
name: signup
spec:
  decoders:
    uuid:
      token:
        uuid:
          any: text
    entity:
      success:
        status: ok
        create:
          token:
            any: dict
          user:
            any: dict
      existing:
        status: ok
        user:
          any: dict
      not_found:
        status: not_found
  update:
    create:
      model: @
      cmds:
        entity: find
    created:
      model: @
      cmds:
        uuid: {}
    token:
      model:
        uuid: @uuid
      cmds:
        entity: signup
    not_found:
      model: {}
    success:
      cmds:
        return: token
    existing:
      cmds:
        return: conflict
  encoders:
    find:
      first: user
      in: @store
      where:
        username: @username
    signup:
      create:
        token:
          id: @uuid
          version: 1
          value: @uuid
          acl: passwd:reset
          user: @uuid
        user:
          id: @uuid
          version: 1
          username: @username
          signup: @id
      in: @store
    token:
      token: @uuid
