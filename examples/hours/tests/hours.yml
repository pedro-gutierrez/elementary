kind: test
name: hours
spec:
  include:
    - http
    - store
    - health
    - roles
    - alice
    - bob
    - charlie
    - floostack
    - codemutiny
    - users
    - organizations
    - packages
    - projects
    - time
    - tasks
  init:
    auth: {}
    json:
      content-type: application/json
    visibility: public
  scenarios:
    - title: Should have a healthcheck
      steps:
        - When I get the health
        - Then I should have a 200
    - title: Users should register once
      tags:
        - register
        - password
      steps:
        - Given the store is empty
        - Given Alice is registered
        - When I register
        - Then I should have a 409
        - Given that user has a password
    - title: Should see public users
      tags:
        - users
        - search
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given Bob is the current user
        - When I search for that user
        - Then I should have a 200
        - Then I should have one item
        - When I get that user
        - Then I should have a 200
    - title: Should not see private users
      steps:
        - Given the store is empty
        - Given a private visibility
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given Bob is the current user
        - When I search for that user
        - Then I should have a 200
        - Then I should have no items
        - When I get that user
        - Then I should have a 401
    - title: I should see my own profile
      steps:
        - Given the store is empty
        - Given a private visibility
        - Given Alice is registered and logged in
        - When I get that user
        - Then I should have a 200
    - title: Anonymous clients should not list users
      steps:
        - Given the store is empty
        - When I get all users
        - Then I should have a 401
    - title: Users should create organizations
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - When I create that organization
        - Then I should have a 409
        - When I get my organizations
        - Then I should have a 200
        - Then I should have one item
        - When I get that organization
        - Then I should have a 200
    - title: Anonymous users should not create organizations
      steps:
        - Given the store is empty
        - Given details for organization Floostack
        - When I create that organization
        - Then I should have a 401
    - title: Anonymous users should not see organizations
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given I am logged out
        - When I search all organizations
        - Then I should have a 401
        - When I get that organization
        - Then I should have a 401
    - title: Non members should see public organizations
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is registered and logged in
        - When I search all organizations
        - Then I should have a 200
        - Then I should have one item
        - When I get that organization
        - Then I should have a 200
    - title: Non members should not see private organizations
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given a private visibility
        - Given organization Floostack
        - Given Bob is registered and logged in
        - When I search all organizations
        - Then I should have a 200
        - Then I should have no items
        - When I get that organization
        - Then I should have a 404
    - title: Owners should add users to organizations
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is registered and logged in
        - Given I am logged in as Alice
        - Given Bob is the current user
        - Given role contractor
        - Given that user belongs to that organization
        - When I add that user to that organization
        - Then I should have a 409
    - title: Should not add self to an organization
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given role contractor
        - When I add that user to that organization
        - Then I should have a 409
    - title: Should not add unknown users to organizations
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given details for Bob
        - Given Bob is the current user
        - Given role contractor
        - When I add that user to that organization
        - Then I should have a 404
    - title: Non owners should not add users to organizations
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is registered and logged in
        - Given Charlie is registered and logged in
        - Given I am logged in as Bob
        - Given details for Charlie
        - Given Charlie is the current user
        - Given role contractor
        - When I add that user to that organization
        - Then I should have a 401
    - title: Users from the same organization should see each other
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is registered and logged in
        - Given Charlie is registered and logged in
        - Given I am logged in as Alice
        - Given Charlie is the current user
        - Given role contractor
        - Given that user belongs to that organization
        - When I get all users in that organization
        - Then I should have a 200
        - Then I should have two items
        - Given I am logged in as Charlie
        - When I get all users in that organization
        - Then I should have a 200
        - Then I should have two items
    - title: Users should not see users from an organization they don't belong to
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is registered and logged in
        - Given Charlie is registered and logged in
        - Given I am logged in as Alice
        - Given Charlie is the current user
        - Given role contractor
        - Given that user belongs to that organization
        - Given I am logged in as Bob
        - When I get that organization
        - Then it should have no users
    - title: Users should see the organizations they belong to
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given organization CodeMutiny
        - Given Bob is registered and logged in
        - Given I am logged in as Alice
        - Given Bob is the current user
        - Given role contractor
        - Given that user belongs to that organization
        - Given I am logged in as Bob
        - When I get my organizations
        - Then I should have a 200
        - Then I should have one item
        - Given I am logged in as Alice
        - When I get my organizations
        - Then I should have a 200
        - Then I should have two items
    - title: Organization owners shoud create packages
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given package 50h
        - When I add that package to that organization
        - Then I should have a 409
        - When I get that package
        - Then I should have a 200
    - title: Non owners should not create packages
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given role contractor
        - Given Bob is the current user
        - Given that user belongs to that organization
        - Given I am logged in as Bob
        - Given details for package 50h
        - When I add that package to that organization
        - Then I should have a 401
    - title: Anonymous users should not create packages
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given I am logged out
        - Given details for package 50h
        - When I add that package to that organization
        - Then I should have a 401
    - title: Non owners should not see organization packages
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given package 50h
        - Given Bob is the current user
        - Given role contractor
        - Given that user belongs to that organization
        - Given I am logged in as Bob
        - When I get all packages in that organization
        - Then I should have a 401
        - When I get that package
        - Then I should have a 401
    - title: Anonymous users should not see packages
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given package 50h
        - Given I am logged out
        - When I get all packages in that organization
        - Then I should have a 401
        - When I get that package
        - Then I should have a 401
    - title: Organization owners should create projects
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given project iot
        - When I create that project
        - Then I should have a 409
        - When I get that project
        - Then I should have a 200
        - When I get all projects in that organization
        - Then I should have a 200
        - Then I should have one item
    - title: Non members should not see projects
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given project iot
        - Given Bob is registered and logged in
        - When I get all projects in that organization
        - Then I should have a 401
        - When I get that project
        - Then I should have a 401
    - title: Anonymous users should not see projects
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given project iot
        - Given I am logged out
        - When I get all projects in that organization
        - Then I should have a 401
        - When I get that project
        - Then I should have a 401
    - title: Owners should add time to projects
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given project iot
        - Given package 50h
        - Given 10 hours
        - Given that time is added to that project
        - When I get that package
        - Then I should have a 200
        - Given 40 hours
        - Then it should have that free time
        - Given 10 hours
        - Then it should have that allocated time
    - title: Members should not add time to projects
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is the current user
        - Given role contractor
        - Given that user belongs to that organization
        - Given project iot
        - Given package 50h
        - Given I am logged in as Bob
        - Given 10 hours
        - When I add that time to that project
        - Then I should have a 401
    - title: Anonymous users should not add time to projects
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given role contractor
        - Given project iot
        - Given package 50h
        - Given I am logged out
        - Given 10 hours
        - When I add that time to that project
        - Then I should have a 401
    - title: Should not allocate more time than available in the package
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given project iot
        - Given 8 hours
        - Given that package
        - Given 10 hours
        - When I add that time to that project
        - Then I should have a 409
        - When I get that package
        - Then I should have a 200
        - Given 8 hours
        - Then it should have that free time
        - Given 0 hours
        - Then it should have that allocated time
    - title: Should not allocate time from packages outside the organization
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given project iot
        - Given organization CodeMutiny
        - Given 8 hours
        - Given that package
        - Given 2 hours
        - When I add that time to that project
        - Then I should have a 401
        - When I get that package
        - Then I should have a 200
        - Given 8 hours
        - Then it should have that free time
        - Given 0 hours
        - Then it should have that allocated time
    - title: Owners should add users to projects
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is the current user
        - Given role contractor
        - Given project iot
        - Given that user belongs to that organization
        - Given that user belongs to that project
        - When I add that user to that project
        - Then I should have a 409
        - When I get all users in that project
        - Then I should have a 200
        - Then I should have one item
    - title: Should not add users to projects from other organizations
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given project iot
        - Given organization CodeMutiny
        - Given Bob is the current user
        - Given role contractor
        - Given that user belongs to that organization
        - When I add that user to that project
        - Then I should have a 401
    - title: Members should not add users to projects
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is the current user
        - Given role contractor
        - Given project iot
        - Given that user belongs to that organization
        - Given I am logged in as Bob
        - When I add that user to that project
        - Then I should have a 401
        - When I get all users in that project
        - Then I should have a 200
        - Then I should have no items
    - title: Anonymous users should not add users to projects
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given Bob is the current user
        - Given role contractor
        - Given project iot
        - Given that user belongs to that organization
        - Given I am logged out
        - When I add that user to that project
        - Then I should have a 401
        - When I get all users in that project
        - Then I should have a 401
    - title: Members should see users from other projects
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Charlie is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given role contractor
        - Given project iot
        - Given Bob is the current user
        - Given that user belongs to that organization
        - Given that user belongs to that project
        - Given project fullpass
        - Given Charlie is the current user
        - Given that user belongs to that organization
        - Given that user belongs to that project
        - Given I am logged in as Bob
        - Given iot is the current project
        - When I get all users in that project
        - Then I should have a 200
        - Then I should have one item
        - Given fullpass is the current project
        - When I get all users in that project
        - Then I should have a 200
        - Then I should have one item
        - Given I am logged in as Charlie
        - Given iot is the current project
        - When I get all users in that project
        - Then I should have a 200
        - Then I should have one item
        - Given fullpass is the current project
        - When I get all users in that project
        - Then I should have a 200
        - Then I should have one item
    - title: Project members should add tasks to projects
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given 10 hours
        - Given that package
        - Given project iot
        - Given role contractor
        - Given Bob is the current user
        - Given that user belongs to that organization
        - Given that user belongs to that project
        - Given 10 hours
        - Given that time is added to that project
        - Given I am logged in as Bob
        - Given today
        - Given 2 hours
        - Given some task
        - When I add that task to that project
        - Then I should have a 201
        - When I get all my tasks
        - Then I should have a 200
        - Then I should have one item
        - When I get my tasks for that project
        - Then I should have a 200
        - Then I should have one item
        - When I get my tasks for that date
        - Then I should have a 200
        - Then I should have one item
        - When I get my tasks for that project and date
        - Then I should have a 200
        - Then I should have one item
    - title: Organisation owners should add tasks to projects
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given 10 hours
        - Given that package
        - Given project iot
        - Given 10 hours
        - Given that time is added to that project
        - Given today
        - Given 2 hours
        - Given some task
        - When I add that task to that project
        - Then I should have a 201
        - When I get all my tasks
        - Then I should have a 200
    - title: Anonymous users should not add tasks to projects
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given 10 hours
        - Given that package
        - Given project iot
        - Given 10 hours
        - Given that time is added to that project
        - Given today
        - Given 2 hours
        - Given some task
        - Given I am logged out
        - When I add that task to that project
        - Then I should have a 401
    - title: Should not allow tasks with invalid time
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given 10 hours
        - Given that package
        - Given project iot
        - Given role contractor
        - Given Bob is the current user
        - Given that user belongs to that organization
        - Given that user belongs to that project
        - Given I am logged in as Bob
        - Given 0 hours
        - Given today
        - Given some task
        - When I add that task to that project
        - Then I should have a 201
        - Given minus 1 hours
        - Given today
        - Given some task
        - When I add that task to that project
        - Then I should have a 400
    - title: Members should list tasks from projects they belong to
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given 10 hours
        - Given that package
        - Given project iot
        - Given role contractor
        - Given Bob is the current user
        - Given that user belongs to that organization
        - Given that user belongs to that project
        - Given I am logged in as Bob
        - Given 0 hours
        - Given today
        - Given some task
        - Given that task is added to that project
        - Given I am logged in as Alice
        - When I get all tasks in that project
        - Then I should have a 200
        - Then I should have one item
        - Given I am logged in as Bob
        - When I get all tasks in that project
        - Then I should have a 200
        - Then I should have one item
    - title: Members should not list tasks from projects they don\'t belong to
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Charlie is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given 10 hours
        - Given that package
        - Given project iot
        - Given role contractor
        - Given Bob is the current user
        - Given that user belongs to that organization
        - Given that user belongs to that project
        - Given Charlie is the current user
        - Given that user belongs to that organization
        - Given I am logged in as Bob
        - Given 0 hours
        - Given today
        - Given some task
        - Given that task is added to that project
        - Given I am logged in as Charlie
        - When I get all tasks in that project
        - Then I should have a 401
    - title: Anonymous users should not list tasks from projects
      steps:
        - Given the store is empty
        - Given Bob is registered and logged in
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given 10 hours
        - Given that package
        - Given project iot
        - Given role contractor
        - Given Bob is the current user
        - Given that user belongs to that organization
        - Given that user belongs to that project
        - Given I am logged in as Bob
        - Given 0 hours
        - Given today
        - Given some task
        - Given that task is added to that project
        - Given I am logged out
        - When I get all tasks in that project
        - Then I should have a 401
    - title: Owners should not list tasks from projects in other organizations
      steps:
        - Given the store is empty
        - Given Alice is registered and logged in
        - Given organization Floostack
        - Given 10 hours
        - Given that package
        - Given project iot
        - Given 0 hours
        - Given today
        - Given some task
        - Given that task is added to that project
        - Given Bob is registered and logged in
        - Given organization CodeMutiny
        - When I get all tasks in that project
        - Then I should have a 401
