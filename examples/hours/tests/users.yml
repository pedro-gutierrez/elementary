kind: test
name: users
spec:
  steps:
    - title: Given that user is registered
      steps:
        - When I register
        - Then I should have a 201
    - title: Given that user has a password
      steps:
        - Given I forgot my password
        - Given I resetted my password
    - title: Given I forgot my password
      steps:
        - When I forget my password
        - Then I should have a 201
        - Then I should have a token
    - title: Given I resetted my password
      steps:
        - When I reset my password
        - Then I should have a 201
    - title: Given a public visibility
      visbility: public
    - title: Given a private visibility
      visibility: private
    - title: When I register
      http:
        method: post
        url:
          - @baseUrl
          - /api/register
        headers:
          merge:
            - @auth
            - content-type: application/json
        body: @user
      as: latest
    - title: When I forget my password
      http:
        method: post
        url:
          - @baseUrl
          - /api/passwd/forgot
        headers:
          merge:
            - @auth
            - content-type: application/json
        body:
          email: @user.email
      as: latest
    - title: When I reset my password
      http:
        method: post
        url:
          - @baseUrl
          - /api/passwd/reset
        headers:
          merge:
            - @auth
            - content-type: application/json
        body:
          email: @user.email
          password: @password
      as: latest
    - title: Then I should have a token
      auth:
        authorization: @latest.body.token
    - title: Given I am logged in
      steps:
        - When I log in
        - Then I should have a 201
        - Then I should have a token
    - title: When I log in
      http:
        method: post
        url:
          - @baseUrl
          - /api/login
        headers:
          merge:
            - @auth
            - content-type: application/json
        body:
          email: @user.email
          password: @password
      as: latest
    - title: When I log out
      http:
        method: post
        url:
          - @baseUrl
          - /api/logout
        headers:
          merge:
            - @auth
            - content-type: application/json
        body: {}
      as: latest
    - title: When I get all users
      http:
        method: get
        url:
          - @baseUrl
          - /api/users
        headers: @auth
      as: latest
    - title: When I search for that user
      http:
        method: get
        url:
          - @baseUrl
          - /api/users
        headers: @auth
        query:
          email: @user.email
      as: latest
    - title: When I get that user
      http:
        method: get
        url:
          - @baseUrl
          - /api/users/
          - @user.id
        headers: @auth
      as: latest
    - title: Then it should have two users
      expect:
        list:
          size: 2
      in: @latest.body.users
    - title: Then it should have no users
      expect:
        without:
          - users
      in: @latest.body

