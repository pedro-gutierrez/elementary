kind: module
name: assignments
spec:
  decoders:
    http:
      assign_package:
        method: POST
        body:
          id:
            any: text
          project:
            any: text
          package:
            any: text
      assign_user:
        method: POST
        body:
          id:
            any: text
          project:
            any: text
          user:
            any: text
      find:
        method: GET
        query:
          project:
            any: text
    store:
      project:
        project:
          any: object
      package:
        package:
          any: object
      user:
        user:
          any: object
      assignments:
        assignments:
          any: list
      packages:
        packages:
          non_empty: list
      no_packages:
        packages:
          empty: list
  update:
    find:
      model:
        context: query
        data:
          project: @data.query.project
      cmds:
        store: find_assignments
    assign_package:
      model:
        context: assign
        data: @data.body
      cmds:
        store: find_assignments
    assign_user:
      model:
        data: @data.body
      cmds:
        store: find_user
    assignments:
      model:
        assignments: @data.assignments
      cmds:
        switch: @model.context
        case:
          query:
            return: assignments
        default:
          store: find_packages
    packages:
      cmds:
        return: conflict
    no_packages:
      cmds:
        store: find_package
    user:
      cmds:
        store: find_project
    package:
      cmds:
        store: find_project
    project:
      cmds:
        store: create
  encoders:
    find_package:
      store: @store
      fetch:
        id: @data.package
      from: packages
      as: package
    find_project:
      store: @store
      fetch:
        id: @data.project
      from: projects
      as: project
    find_user:
      store: @store
      fetch:
        id: @data.user
      from: users
      as: user
    find_assignments:
      store: @store
      find:
        project: @data.project
      from: assignments
      as: assignments
    find_packages:
      store: @store
      find:
        status: open
        id:
          $in:
            map: @assignments
            with: @package
      from: packages
      as: packages
    assignments:
      status: 200
      headers:
        content-type: application/json
      body: @assignments
    create:
      store: @store
      insert:
        merge:
          - @data
          - created:
              now: {}
      into: assignments
