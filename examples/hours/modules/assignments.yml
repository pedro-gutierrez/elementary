kind: module
name: assignments
spec:
  decoders:
    http:
      create:
        method: POST
        body:
          id:
            any: text
          project:
            any: text
          package:
            any: text
      get_by_project:
        method: GET
        query:
          project:
            any: text
    store:
      project:
        project:
          any: object
      package:
        package:
          any: object
      assignments:
        assignments:
          any: list
  update:
    get_by_project:
      model:
        project: @data.query.project
      cmds:
        store: find_by_project
    assignments:
      model:
        data: @data.assignments
      cmds:
        return: data
    create:
      model:
        data: @data.body
      cmds:
        store: find_package
    package:
      cmds:
        store: find_project
    project:
      cmds:
        store: create
  encoders:
    find_package:
      store: @store
      fetch:
        id: @data.package
      from: packages
      as: package
    find_project:
      store: @store
      fetch:
        id: @data.project
      from: projects
      as: project
    find_by_project:
      store: @store
      find:
        project: @project
      from: assignments
      as: assignments
    create:
      store: @store
      insert:
        merge:
          - @data
          - created:
              now: {}
      into: assignments
