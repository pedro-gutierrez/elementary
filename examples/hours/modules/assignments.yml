kind: module
name: assignments
spec:
  decoders:
    http:
      assign_package:
        method: POST
        body:
          id:
            any: text
          project:
            any: text
          package:
            any: text
      assign_user:
        method: POST
        body:
          id:
            any: text
          project:
            any: text
          user:
            any: text
      find:
        method: GET
        query:
          project:
            any: text
    store:
      project:
        project:
          any: object
      package:
        package:
          any: object
      user:
        user:
          any: object
      assignments:
        assignments:
          any: list
  update:
    find:
      model:
        project: @data.query.project
      cmds:
        store: find_assignments
    assignments:
      model:
        data: @data.assignments
      cmds:
        return: data
    assign_package:
      model:
        data: @data.body
      cmds:
        store: find_package
    assign_user:
      model:
        data: @data.body
      cmds:
        store: find_user
    user:
      cmds:
        store: find_project
    package:
      cmds:
        store: find_project
    project:
      cmds:
        store: create
  encoders:
    find_package:
      store: @store
      fetch:
        id: @data.package
      from: packages
      as: package
    find_project:
      store: @store
      fetch:
        id: @data.project
      from: projects
      as: project
    find_user:
      store: @store
      fetch:
        id: @data.user
      from: users
      as: user
    find_assignments:
      store: @store
      find:
        project: @project
      from: assignments
      as: assignments
    create:
      store: @store
      insert:
        merge:
          - @data
          - created:
              now: {}
      into: assignments
