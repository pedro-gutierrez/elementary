kind: module
name: ui_tests
spec:
  init:
    model:
      tests: []
      indexed: {}
      mode: scenarios
      query: ""
      filtered: []
      view: scenarios-view
    cmds:
      http: get-tests
  decoders:
    http:
      tests:
        tests:
          status: 200
          body:
            any: list
    ui:
      query:
        query:
          any: text
      clear-search:
        clear-search: ""
      set-mode:
        mode:
          any: text
      show-scenario:
        show-scenario:
          any: text
      show-step:
        show-step:
          any: text
  update:
    tests:
      model:
        tests: @data.tests.body
        indexed:
          encoder: indexed
          params:
            scenarios: @data.tests.body
        filtered:
          encoder: filtered
          params:
            tests: @data.tests.body
            query: @model.query
            mode: @model.mode
      cmds:
        ui: {}
    query:
      model:
        query: @data.query
        filtered:
          encoder: filtered
          params:
            tests: @model.tests
            query: @model.query
            mode: @model.mode
      cmds:
        ui: {}
    clear-search:
      model:
        query: ""
        filtered:
          encoder: filtered
          params:
            tests: @model.tests
            query: ""
            mode: @model.mode
      cmds:
        ui: {}
    set-mode:
      model:
        mode: @data.mode
        filtered:
          encoder: filtered
          params:
            tests: @model.tests
            query: @model.query
            mode: @data.mode
        view:
          encoder: view-for-mode
          params:
            mode: @data.mode
      cmds:
        ui: {}
    show-scenario:
      model:
        mode: scenarios
        scenario:
          resolve:
            - model.indexed
            - @data.show-scenario
        view: scenario-view
      cmds:
        ui: {}
    show-step:
      model:
        mode: steps
        step:
          resolve:
            - model.indexed
            - @data.show-step
        view: step-view
      cmds:
        ui: {}
  encoders:
    get-tests:
      method: get
      path: /tests.json
      as: tests
    indexed:
      pipeline:
        - flat_map: @scenarios
          with: @steps
        - combine: @items
          with: @scenarios
        - index: {}
    filtered:
      switch: @mode
      case:
        steps:
          pipeline:
            - flat_map: @tests
              with: @steps
            - filter: @items
              with:
                title:
                  like: @query
        scenarios:
          pipeline:
            - filter: @tests
              with:
                title:
                  like: @query
    view-for-mode:
      format: "{{ mode }}-view"
    scenarios-view:
      tag: div
      children:
        loop: @filtered
        with: scenario-item-view
    steps-view:
      tag: div
      children:
        loop: @filtered
        with: step-item-view
    scenario-item-view:
      tag: div
      attrs:
        key: @id
        class: pointer
        onclick:
          show-scenario: @id
      children:
        - view: summary-view
    step-item-view:
      tag: div
      attrs:
        key: @id
        class: pointer
        onclick:
          show-step: @id
      children:
        - view: summary-view
    scenario-view:
      tag: div
      children:
        - tag: div
          attrs:
            class: pointer
            onclick:
              show-scenario: @scenario.id
          children:
            - view: summary-view
              params: @scenario
        - tag: div
          children:
            loop: @scenario.steps
            with: step-item-view
    step-view:
      tag: div
      children:
        - tag: div
          attrs:
            class: pointer
            onclick:
              show-step: @step.id
          children:
            - view: summary-view
              params: @step
              ##- view: back-to-scenario-view
              ##  params: @scenario
    summary-view:
      tag: div
      children:
        - view: tags-view
          params:
            tags:
              - label: @status
                color: success
                size: normal
              - label:
                  format: "{{ time }}ms"
                color: light
                size: small
        - view: item-title-view
          params:
            icon:
              encoder: icon-for-item
            title: @title
            id: @id
    item-title-view:
      tag: h6
      attrs:
        class: title is-6 is-clearfix
      children:
        - tag: div
          attrs:
            style:
              display: flex
              align-items: center
          children:
            - view: icon-view
            - tag: span
              attrs:
                style:
                  margin-left: 15px
              children:
                - @title

    back-to-scenario-view:
      tag: div
      children:
        - view: item-title-view
          params:
            icon: fas fa-list-ol
            title: @title
            id: @id
    icon-for-item:
      either:
        - when:
            has: steps
          then: fas fa-list-ol
        - when:
            match:
              title:
                like: Given
          then: fas fa-thumbtack
        - when:
            match:
              title:
                like: When
          then: fas fa-arrow-up
        - when:
            match:
              title:
                like: Then
          then: fas fa-check
        - then: fas fa-question
    tags-view:
      tag: div
      attrs:
        class: tags is-pulled-right
      children:
        loop: @tags
        with: tag-view
    tag-view:
      tag: span
      attrs:
        class:
          format: "tag tag-{{size}} is-{{color}}"
      children:
        - capitalize: @label
    icon-view:
      tag: span
      attrs:
        class: icon is-medium
      children:
        - tag: span
          attrs:
            class: fa-stack
          children:
            - tag: i
              attrs:
                style:
                  color: "#434C5E"
                class: fas fa-circle fa-stack-2x
            - tag: i
              attrs:
                class:
                  format: "fa-stack-1x fa-inverse {{icon}}"
