kind: module
name: ui_tests
spec:
  init:
    model:
      delay: 200
      tests: []
      indexed: {}
      filtered: []
      view: steps-view
      step: ""
      tags: []
      selectedTags: []
      tagGroups: {}
    cmds:
      ui: downloading-view
      events: ready
  decoders:
    http:
      tests:
        tests:
          status: 200
          body:
            any: list
    ui:
      show-step:
        show-step:
          any: text
      show-steps:
        show-steps:
          any: object
      toggle-tag:
        toggle-tag:
          any: text
    events:
      ready:
        ready:
          any: object
      downloaded:
        downloaded:
          any: object
      indexed:
        indexed:
          any: object
      tagged:
        tagged:
          any: object
  update:
    ready:
      cmds:
        http: get-tests
    tests:
      model:
        tests: @data.tests.body
      cmds:
        ui: indexing-view
        events: downloaded
    downloaded:
      model:
        indexed:
          encoder: index-data
          params:
            scenarios: @model.tests
      cmds:
        ui: tagging-view
        events: indexed
    indexed:
      model:
        let:
          tags:
            encoder: extract-tags
            params:
              steps: @model.indexed.$
        in:
          tags: @tags
          tagGroups:
            encoder: group-tags
            params:
              tags: @tags
      cmds:
        events: tagged
    tagged:
      model:
        filtered: @model.indexed.$
      cmds:
        ui: layout-view
    show-step:
      model:
        step:
          resolve:
            - model.indexed
            - @data.show-step
        view: step-view
      cmds:
        ui: {}
    show-steps:
      model:
        view: steps-view
      cmds:
        ui: {}
    toggle-tag:
      model:
        let:
          selectedTags:
            encoder: toggle-tag
            params:
              tags: @model.selectedTags
              tag: @data.toggle-tag
        in:
          selectedTags: @selectedTags
          filtered:
            encoder: filter-steps
            params:
              steps: @model.indexed.$
              tags: @selectedTags
      cmds:
        ui: {}
  encoders:
    ready:
      ready: {}
      delay: @delay
    downloaded:
      downloaded: {}
      delay: @delay
    indexed:
      indexed: {}
      delay: @delay
    tagged:
      tagged: {}
      delay: @delay
    get-tests:
      method: get
      path: /tests.json
      as: tests
    step-tags:
      pipeline:
        - concat:
          - @step.tags
          - @step.spec.http.method
          - text: @step.output.latest.status
          - flat_map: @step.spec.http.url
            as: parts
            with:
              split: @parts
              using: /
        - reject: {}
          with:
            one_of:
              - api
              - like:
                  data: "@"
              - empty: {}
    index-data:
      pipeline:
        - flat_map: @scenarios
          as: scenario
          with:
            map: @scenario.steps
            as: step
            with:
              merge:
                - @step
                - tags: @scenario.tags
        - filter: {}
          with:
            spec:
              http:
                any: object
        - map: {}
          as: step
          with:
            merge:
              - @step
              - tags:
                  encoder: step-tags
        - index: {}
    filter-steps:
      either:
        - when:
            empty: @tags
          then: @steps
        - filter: @steps
          with:
            tags:
              all: @tags
    extract-tags:
      pipeline:
        - flat_map: @steps
          as: step
          with: @step.tags
        - unique: {}
    group-tags:
      group: @tags
      as: tag
      with:
        either:
          - when:
              member:
                - ["200", "201", "400", "401", "404", "409", "500"]
                - @tag
            then: status
          - when:
              member:
                - ["get", "put", "post", "delete"]
                - @tag
            then: method
          - then: resource
    toggle-tag:
      either:
        - when:
            member:
              - @tags
              - @tag
          remove: @tag
          from: @tags
        - add: @tag
          to: @tags
    search-enabled:
      equal:
        - steps-view
        - @view
    steps-view:
      tag: div
      children:
        - view: tag-groups-view
        - view: steps-items-view
    tag-groups-view:
      tag: div
      attrs:
        style:
          margin-bottom: 30px
      children:
        - view: tag-group-view
          params:
            title: Resources
            tags: @tagGroups.resource
            selectedTags: @selectedTags
        - view: tag-group-view
          params:
            title: Methods
            tags: @tagGroups.method
            selectedTags: @selectedTags
        - view: tag-group-view
          params:
            title: Status codes
            tags: @tagGroups.status
            selectedTags: @selectedTags
    tag-group-view:
      tag: div
      attrs:
        class: has-text-centered
        style:
          margin-bottom: 5px
      children:
        - view: tag-cloud-view
    tag-cloud-view:
      tag: div
      attrs:
        style:
          display: inline-block
          margin-left: 5px
        class: tags
      children:
        loop: @tags
        as: tag
        with: tag-cloud-item-view
        params:
          selected: @selectedTags
    tag-cloud-item-view:
      tag: a
      attrs:
        onclick:
          toggle-tag: @tag
        class:
          format: tag is-{{ color }}
          params:
            color:
              either:
                - when:
                    member:
                      - @selected
                      - @tag
                  then: primary
                - light
      children:
        - capitalize: @tag
    steps-items-view:
      tag: div
      attrs:
        class: columns is-12 is-multiline
      children:
        loop: @filtered
        with: step-item-view
    step-item-view:
      tag: div
      attrs:
        key: @id
        class: column is-one-third item-view
        onclick:
          show-step: @id
        style:
          cursor: pointer
      children:
        - view: summary-view
    step-view:
      tag: div
      attrs:
        key: @step.id
      children:
        - tag: p
          attrs:
            style:
              margin-bottom: 10px
          children:
            - tag: a
              attrs:
                class: link
                onclick:
                  show-steps: {}
              children:
                - Back

        - view: summary-view
          params: @step
        - view: step-section-view
          params:
            title: Request
            code:
              take: [method, url, query, headers, body]
              from: @step.output.latest.request
        - view: step-section-view
          params:
            title: Response
            code:
              take: [status, headers, body]
              from: @step.output.latest
    step-section-view:
      tag: div
      attrs:
        class: box column is-radiusless is-shadowless
        style:
          margin-bottom: 25px
      children:
        - view: tag-view
          params:
            label: @title
            color: light
            size: normal
        - code:
            style:
              class: has-background-white
            source: @code
    summary-view:
      tag: div
      attrs:
        class: box column is-radiusless is-shadowless
      children:
        - tag: a
          attrs:
            class: has-text-weight-normal
          children:
            - @title
        - view: tags-view
          params:
            tags:
              pipeline:
                - map: @tags
                  with:
                    label: @item
                    color: light
                    size: normal
                - combine: {}
                  with:
                    - label:
                        format: "{{ time }}ms"
                      color: light
                      size: small
    tags-view:
      tag: div
      attrs:
        style:
          margin-top: 5px
        class: tags
      children:
        loop: @tags
        with: tag-view
    tag-view:
      tag: span
      attrs:
        class:
          format: "tag tag-{{size}} is-{{color}}"
      children:
        - capitalize: @label
