kind: module
name: add_user_to_organization
spec:
  decoders:
    http:
      create:
        body:
          user:
            any: text
          role:
            one_of:
              - client
              - contractor
    store:
      not_found:
        user: not_found
      user:
        user:
          any: object
  update:
    create:
      model:
        member: @data.body.user
        memberRole: @data.body.role
      cmds:
        store: find_user
    user:
      cmds:
        store: create
    not_found:
      cmds:
        return: not_found
  encoders:
    find_user:
      store: @store
      fetch:
        id: @member
      from: users
      as: user
    create:
      store: @store
      insert:
        id:
          uuid: {}
        organization: @organization.id
        user: @member
        role: @memberRole
      into: memberships
