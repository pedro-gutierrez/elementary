kind: module
name: google_token
spec:
  decoders:
    http:
      get_token:
        query:
          code:
            any: text
          state:
            any: text
      token:
        body:
          access_token:
            any: text
          expires_in:
            any: number
          id_token:
            any: text
    jwt:
      claims:
        claims:
          email:
            any: text
          sub:
            any: text
  update:
    get_token:
      model: "@data.query"
      cmds:
        http: get_token
    token:
      model: "@data.body"
      cmds:
        jwt: decode_token
    claims:
      model:
        session:
          uuid: {}
      cmds:
        return: session
  encoders:
    get_token:
      object:
        method: post
        url: https://accounts.google.com/o/oauth2/token
        headers:
          content-type: application/x-www-form-urlencoded
        body:
          client_id: "@client" 
          client_secret: "@secret"
          grant_type: authorization_code
          redirect_uri:
            format: "{{ baseUrl }}{{ redirectPath }}"
          code: "@code"
    decode_token:
      decode: "@id_token"
    session:
      status: 302
      headers:
        location:
          format: "{{ baseUrl }}/#/s={{ session }}"
    ##github-authorize-url:
    ##  urlencoded:
    ##    base: "https://github.com/login/oauth/authorize"
    ##    params:
    ##      client_id: "@github.client"
    ##      state: "@state"
    ##      redirect_uri:
    ##        format: "{{ baseUrl}}/tokens/github"
