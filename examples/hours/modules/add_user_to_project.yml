kind: module
name: add_user_to_project
spec:
  decoders:
    http:
      add_member:
        body:
          user:
            any: text
    store:
      user:
        user:
          any: object
      not_found:
        user: not_found
      is_in_organization:
        new_user_memberships:
          non_empty: list
      is_not_in_organization:
        new_user_memberships:
          empty: list
  update:
    add_member:
      model:
        member: @data.body.user
      cmds:
        store: find_user
    not_found:
      cmds:
        return: not_found
    user:
      model:
        member: @data.user
      cmds:
        store: find_new_user_memberships
    is_not_in_organization:
      cmds:
        return: unauthorized
    is_in_organization:
      cmds:
        store: create
  encoders:
    find_user:
      store: @store
      fetch:
        id: @member
      from: users
      as: user
    find_new_user_memberships:
      store: @store
      find:
        user: @member.id
        organization: @organization.id
      from: memberships
      as: new_user_memberships
    create:
      store: @store
      insert:
        id:
          uuid: {}
        project: @project.id
        user: @member.id
      into: memberships
