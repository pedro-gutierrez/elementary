kind: module
name: get_package
spec:
  decoders:
    http:
      get:
        params:
          id:
            any: text
    store:
      package:
        package:
          any: object
  update:
    get:
      model:
        id: @data.params.id
      cmds:
        store: fetch
    package:
      model:
        package: @data.package
      cmds:
        store: package_allocated_time
    package_allocated_time:
      model:
        data:
          let:
            package: @model.package
            allocatedTime: @data.package_allocated_time.allocatedTime
          in:
            merge:
              - @package
              - allocatedTime: @allocatedTime
                freeTime:
                  diff:
                    - @package.totalTime
                    - @allocatedTime
      cmds:
        return: data
  encoders:
    fetch:
      store: @store
      fetch:
        id: @id
      from: packages
      as: package
