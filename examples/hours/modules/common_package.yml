kind: module
name: common_package
spec:
  decoders:
    store:
      package_allocated_time:
        package_allocated_time:
          first:
            with:
              allocatedTime:
                any: number
          otherwise:
            allocatedTime: 0
  encoders:
    find_package:
      store: @store
      fetch:
        id: @package
      from: packages
      as: package
    package_allocated_time:
      store: @store
      aggregate:
        - $match:
            package: @package.id
        - $group:
            _id: $package
            allocatedTime:
              $sum: $allocatedTime
      from: memberships
      as: package_allocated_time
    package_free_time:
      diff:
        - @package.totalTime
        - @allocated_time
