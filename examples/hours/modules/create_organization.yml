kind: module
name: create_organization
spec:
  decoders:
    http:
      create:
        body:
          id:
            any: text
          name:
            text:
              - downcase
              - trim
          visibility:
            one_of:
              - public
              - private
    store:
      membership:
        membership: created
      organization:
        organization: created
      conflict:
        one_of:
          - membership: conflict
          - organization: conflict
  update:
    create:
      model:
        id: @data.body.id
        name: @data.body.name
        visibility: @data.body.visibility
      cmds:
        store: create_membership
    membership:
      cmds:
        store: create_organization
    organization:
      cmds:
        return: created
  encoders:
    create_membership:
      store: @store
      insert:
        id:
          uuid: {}
        organization: @id
        user: @user.id
        role: owner
      into: memberships
      as: membership
    create_organization:
      store: @store
      insert:
        id: @id
        name: @name
        created:
          now: {}
        owner: @user.id
        visibility: @visibility
      into: organizations
      as: organization
