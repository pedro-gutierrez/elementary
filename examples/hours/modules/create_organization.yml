kind: module
name: create_organization
spec:
  decoders:
    http:
      create:
        body:
          id:
            any: text
          name:
            text:
              - downcase
              - trim
          visibility:
            one_of:
              - public
              - private
  update:
    create:
      model:
        id: @data.body.id
        name: @data.body.name
        visibility: @data.body.visibility
      cmds:
        store: create
  encoders:
    create:
      store: @store
      insert:
        id: @id
        name: @name
        created:
          now: {}
        owner: @user.id
        users:
          - id: @user.id
            role: owner
        visibility: @visibility
      into: organizations
